---
title: "AWS Batch: é…åˆ—ã‚¸ãƒ§ãƒ–ã®å®Œäº†ã‚’å¾…ã£ã¦ã‹ã‚‰é€šçŸ¥ã™ã‚‹"
emoji: "ğŸ”–"
type: "tech"
topics:
  - "aws"
published: true
published_at: "2023-04-24 15:11"
---

æ¥­å‹™ã§AWS Batchã«è§¦ã‚Œã‚‹æ©Ÿä¼šãŒã‚ã‚Šã¾ã—ãŸã®ã§ã€å›°ã£ãŸã¨ã“ã‚ã‚’è¨˜äº‹ã«ã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚

## çµŒç·¯
å½“åˆã€è¤‡æ•°ã®ã‚¸ãƒ§ãƒ–ã‚’[é…åˆ—ã‚¸ãƒ§ãƒ–](https://docs.aws.amazon.com/ja_jp/batch/latest/userguide/array_jobs.html)ç­‰ã¯ä½¿ç”¨ã›ãšã€lambdaä¸Šã‹ã‚‰submitã—ã¦ã„ã¾ã—ãŸãŒã€ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã•ã‚Œã¦ã„ãŸã»ã†ãŒæ‰±ã„ã‚„ã™ã„ã¨ã„ã£ãŸã“ã¨ã‹ã‚‰é…åˆ—ã‚¸ãƒ§ãƒ–ã‚’ä½¿ç”¨ã—ãŸæ–¹æ³•ã‚’æ¤œè¨ã—ã‚ˆã†ã¨ã„ã†ã“ã¨ã«ãªã‚Šã¾ã—ãŸã€‚

å˜ã«ã‚¸ãƒ§ãƒ–ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®å¤‰æ›´ã«ã‚ˆã£ã¦ã€ã‚¤ãƒ™ãƒ³ãƒˆé€šçŸ¥ã‚’è¡Œã†æ–¹æ³•ã¯è¨˜äº‹ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸãŒã€ã‚¸ãƒ§ãƒ–å…¨ä½“ã®å®Œäº†é€šçŸ¥ã‚’è¡Œã†æ–¹æ³•ã¯è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ããªã‹ã£ãŸã®ã§ã€ãƒ¡ãƒ¢ç¨‹åº¦ã«æ®‹ã—ã¦ãŠã“ã†ã¨æ€ã„ã¾ã™ã€‚

å…·ä½“çš„ã«ã¯ç”»åƒã®ã‚ˆã†ãªå½¢å¼ã¨ãªã‚Šã¾ã™ã€‚
å®Œäº†é€šçŸ¥ãŒç™ºç«ã•ã‚Œã‚‹ã¨å¾Œç¶šã®lambdaãŒå®Ÿè¡Œã•ã‚Œã‚‹å½¢å¼ã§ã™ã€‚
![](https://storage.googleapis.com/zenn-user-upload/fa5dca514509-20230418.png)

## å®Ÿè£…
### äº‹å‰æº–å‚™
[ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«](https://docs.aws.amazon.com/ja_jp/batch/latest/userguide/array_index_example.html)ã®ã‚¹ãƒ†ãƒƒãƒ—ï¼“ã®Batchã«ã‚¸ãƒ§ãƒ–å®šç¾©ã‚’è¡Œã†ã¨ã“ã‚ã¾ã§é€²ã‚ã¦ãã ã•ã„ã€‚

**ãã®ä»–è¨­å®š**
ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ç’°å¢ƒ
- EC2 ã®ãƒ—ãƒ­ãƒ“ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ç”¨
- åç§°ã¯ã€Œprint-color-computingã€
- ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãƒ­ãƒ¼ãƒ«ã«AdministarAccess

ã‚¸ãƒ§ãƒ–ã‚­ãƒ¥ãƒ¼
- åç§°ã¯ã€Œprint-color-queueã€

### lambda, eventBridgeã®ä½œæˆ
batchãŒçµ‚äº†ã—ãŸå¾Œã«å‘¼ã³å‡ºã•ã‚Œã‚‹lambdaã¨eventBridgeã®è¨­å®šã‚’è¡Œã„ã¾ã™ã€‚

```python
def lambda_handler(event, context):
    arrayProperties = event["detail"].get("arrayProperties", dict())
    print(arrayProperties.get("index", "root"))
```

```json:ã‚¤ãƒ™ãƒ³ãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³
{
  "source": ["aws.batch"],
  "detail-type": ["Batch Job State Change"],
  "detail": {
    "jobDefinition": ["ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã§ä½œæˆã—ãŸjobDefinitionã®Arn"],
    "status": ["SUCCEEDED"] ã€€ã€€// æˆåŠŸæ™‚ã®ã¿é€šçŸ¥
  }
}
```


### ä¸€æ—¦ã€submit
ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã¨åŒæ§˜ã€jobã‚’submitã—ã¦ã¿ã¾ã™ã€‚

```json:print-color-job.json
{
  "jobName": "print-color",
  "jobQueue": "print-color-queue",
  "arrayProperties": {
    "size": 7
  },
  "jobDefinition": "print-color"
}
```
```
aws batch submit-job --cli-input-json file://print-color-job.json
```

æˆåŠŸã™ã‚‹ã¨å†™çœŸã®ã‚ˆã†ã«ã€lambdaå´ã§é…åˆ—ã®indexæƒ…å ±ãŒãƒ­ã‚°ã«è¡¨ç¤ºã•ã‚Œã‚‹ã¨æ€ã„ã¾ã™ã€‚
å®Ÿè¡Œå›æ•°ã¨ã—ã¦ã¯8å›(è¦ªã‚¸ãƒ§ãƒ–ã¨å­ã‚¸ãƒ§ãƒ–ã®åˆè¨ˆ)ã§ã™ã€‚
![](https://storage.googleapis.com/zenn-user-upload/833629b8bc9e-20230424.png)


## è¦ªã‚¸ãƒ§ãƒ–ã ã‘ã‚’é€šçŸ¥ã™ã‚‹ã‚ˆã†ã«ä¿®æ­£ã™ã‚‹
è¦ªã‚¸ãƒ§ãƒ–ã¨å­ã‚¸ãƒ§ãƒ–ã§ã‚¤ãƒ™ãƒ³ãƒˆæƒ…å ±ã®é•ã„ã‚’ç¢ºèªã—ã¦ã¿ã¾ã™ã€‚
*å…¨ã¦è¼‰ã›ã‚‹ã¨ã‹ãªã‚Šé•·ã„ã®ã§ã€ä¸è¦ãªã¨ã“ã‚ã¯å‰Šé™¤ã—ã¦ã„ã¾ã™ã€‚

```json:å­ã‚¸ãƒ§ãƒ–
{
  "version": "0",
  "detail-type": "Batch Job State Change",
  "source": "aws.batch",
  "detail": {
    "attempts": [
      {
        "container": {
          "containerInstanceArn": "",
          "taskArn": "",
          "exitCode": 0,
          "logStreamName": "",
          "networkInterfaces": []
        },
        "startedAt": 0,
        "stoppedAt": 0,
        "statusReason": "Essential container in task exited"
      }
    ],
    "statusReason": "Essential container in task exited",
    "container": {
      "image": "",
      "command": [],
      "volumes": [],
      "environment": [],
      "mountPoints": [],
      "ulimits": [],
      "exitCode": 0,
      "containerInstanceArn": "",
      "taskArn": "",
      "logStreamName": "",
      "networkInterfaces": [],
      "resourceRequirements": [
        {
          "value": "250",
          "type": "MEMORY"
        },
        {
          "value": "1",
          "type": "VCPU"
        }
      ],
      "secrets": []
    },
    "arrayProperties": {
      "statusSummary": {},
      "index": 1
    }
  }
}
```

```json:è¦ªã‚¸ãƒ§ãƒ–
{
  "version": "0",
  "detail-type": "Batch Job State Change",
  "source": "aws.batch",
  "detail": {
    "attempts": [],
    "container": {
      "image": "",
      "command": [],
      "volumes": [],
      "environment": [],
      "mountPoints": [],
      "ulimits": [],
      "networkInterfaces": [],
      "resourceRequirements": [
        {
          "value": "250",
          "type": "MEMORY"
        },
        {
          "value": "1",
          "type": "VCPU"
        }
      ],
      "secrets": []
    },
    "arrayProperties": {
      "statusSummary": {
        "STARTING": 0,
        "FAILED": 0,
        "RUNNING": 0,
        "SUCCEEDED": 2,
        "RUNNABLE": 0,
        "SUBMITTED": 0,
        "PENDING": 0
      },
      "size": 2
    }
  }
}
```

è¦‹æ¯”ã¹ã¦ã¿ã‚‹ã¨ã„ãã¤ã‹é•ã„ãŒã‚ã‹ã‚Šã¾ã™ã€‚
"arrayProperties"ã®è¦ç´ ãŒ"size"ã¨"index"ã§ç•°ãªã£ã¦ã„ãŸã‚Šã€å­ã‚¸ãƒ§ãƒ–ã®æ–¹ã®"container"ã®ä¸­ã«ã¯å®Ÿè¡Œã—ãŸã‚³ãƒ³ãƒ†ãƒŠæƒ…å ±ã‚„ãƒ­ã‚°ã®æƒ…å ±ãªã©ãŒå…¥ã£ã¦ã„ã¾ã™ã­ã€‚

ã“ã‚Œã‚‰ã®é•ã„ã‚’åˆ©ç”¨ã—ã¦è¦ªã‚¸ãƒ§ãƒ–ã®å®Œäº†æ™‚ã®ã¿ã€lambdaã‚’å®Ÿè¡Œã™ã‚‹ã‚ˆã†ã«ä¿®æ­£ã—ã¾ã™ã€‚
*ä»Šå›ã¯ã‚¤ãƒ™ãƒ³ãƒˆã‚¹ã‚­ãƒ¼ãƒã«è¨˜è¼‰ã®ã‚ã‚‹é …ç›®ã®ä¸­ã‹ã‚‰é¸æŠã—ã¦ã„ã¾ã™ãŒã€è¦ªã‚¸ãƒ§ãƒ–ã¨å­ã‚¸ãƒ§ãƒ–ã§ç•°ãªã‚‹è¦ç´ ã§ã‚ã‚Œã°ã€ãªã‚“ã§ã‚‚æ§‹ã„ã¾ã›ã‚“ã€‚

```json:ã‚¤ãƒ™ãƒ³ãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³(ä¿®æ­£å¾Œ)
{
  "source": ["aws.batch"],
  "detail-type": ["Batch Job State Change"],
  "detail": {
    "jobDefinition": ["ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã§ä½œæˆã—ãŸjobDefinitionã®Arn"],
    "status": ["SUCCEEDED"],ã€€ã€€// æˆåŠŸæ™‚ã®ã¿é€šçŸ¥
    "container": {
      "containerInstanceArn": [{
        "exists": false
      }]
    }
  }
}
```

## å‹•ä½œç¢ºèª
å†åº¦ã€ã‚¸ãƒ§ãƒ–ã‚’é€ä¿¡ã—ã¦ã¿ã¾ã™ã€‚
lambdaã‹ã‚‰å®Ÿè¡Œå›æ•°ã‚’ç¢ºèªã—ã¦ã¿ã‚‹ã¨8å› â†’ 1å›ã«æ¸›ã£ãŸã“ã¨ãŒç¢ºèªã§ãã‚‹ã¨æ€ã„ã¾ã™ã€‚
![](https://storage.googleapis.com/zenn-user-upload/d0a1ce885c3e-20230424.png)

## ã¾ã¨ã‚
ä»Šå›ã¯é…åˆ—ã‚¸ãƒ§ãƒ–ã®è¦ªã‚¸ãƒ§ãƒ–ã®çµ‚äº†ã«ä¼´ã£ã¦é€šçŸ¥ã‚’è¡Œã†æ–¹æ³•ã‚’ã”ç´¹ä»‹ã—ã¾ã—ãŸã€‚
AWSã¯ä»Šå›ã®ã‚ˆã†ã«ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®è¦ç´ ãŒé•ã£ã¦ã„ã¦ã€ãªã‹ãªã‹æ°—ã¥ã‘ãªã„ã“ã¨ã‚‚å¤šã„ã§ã™ãŒã€ä»Šå¾Œã‚‚ã“ã®ã‚ˆã†ãªå½¢ã§è¨˜äº‹ã«ã§ãã‚Œã°ã¨æ€ã„ã¾ã™ã€‚


ä»¥ä¸Šã§ã™ã€‚