---
title: "TypeSpecã‚’ä½¿ã£ã¦ã¿ãŸ"
emoji: "ğŸ¥"
type: "tech"
topics:
  - "openapi"
published: true
published_at: "2024-07-18 22:52"
---

# ã¯ã˜ã‚ã«
ç§ã¯æ¥­å‹™ã§AWSã®SAM(Serverless Application Model)ã‚’ä½¿ã£ã¦ãƒªã‚½ãƒ¼ã‚¹ã‚’æ§‹ç¯‰ã™ã‚‹ã“ã¨ãŒå¤šã„ã§ã™ã€‚ã‚ã‚‹ç¨‹åº¦ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒå¤§ãããªã£ã¦ã„ãã¨yamlã«å®šç¾©ã—ãŸãƒªã‚½ãƒ¼ã‚¹ãŒå¤šããªã‚Šã€å¤‰æ›´ã—ãŸã„ãƒªã‚½ãƒ¼ã‚¹ã‚’æ¢ã™ã®ã«è‹¦åŠ´ã™ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚

APIå®šç¾©ãªã©ã¯ç‰¹ã«è‚¥å¤§åŒ–ã—ã‚„ã™ãã€ã‚‚ã†å°‘ã—ç°¡å˜ã«æ›¸ã‘ãªã„ã‚‚ã®ã‹ã¨æ‚©ã‚€ã“ã¨ãŒå¤šã„ã§ã™ã€‚
ä»Šå›ã¯ä»£æ›¿ã®æ¤œè¨å¯¾è±¡ã¨ã—ã¦TypeSpecã‚’è§¦ã£ã¦ã¿ãŸã®ã§ã€ç°¡å˜ã«ã¾ã¨ã‚ãŸã„ã¨æ€ã„ã¾ã™ã€‚

# TypeSpecã¨ã¯
https://typespec.io/
[TypeSpec](https://typespec.io/)ã¯MicrosoftãŒé–‹ç™ºã—ã¦ã„ã‚‹APIå®šç¾©è¨€èªã§ã™ã€‚
REST, OpenAPI, gRPCã¨ä¸€é€šã‚Šã®å®šç¾©ãŒå¯èƒ½ã§ã™ã€‚

ç‹¬è‡ªæ‹¡å¼µå­(`.tsp`)ã‚’ä½¿ç”¨ã—ã€å¤šãã®å®šç¾©ãŒãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ã‚’ä½¿ã£ã¦å®šç¾©ã—ã¾ã™ã€‚
ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ãŒè¿½åŠ ã•ã‚ŒãŸTypeScriptãƒ©ã‚¤ã‚¯ã®APIå®šç¾©ã¨ã„ã†æ„Ÿã˜ã§ã™ã€‚

# ä½¿ã£ã¦ã¿ã‚‹
## ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ
nodejsã§ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã€TypeSpecã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚
```sh
npx tsp init 
```

å®Ÿè¡Œã™ã‚‹ã¨ä»¥ä¸‹ã®è³ªå•ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚©ãƒ«ãƒ€ã‚’åˆæœŸåŒ–ã™ã‚‹ã‹ (ãƒ•ã‚©ãƒ«ãƒ€ã«æ—¢ã«ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒã‚ã‚‹å ´åˆã®ã¿)
- ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
    - ä»Šå›ã¯REST APIå®šç¾©ãªã®ã§2ç•ªç›®ã®`Generic REST API`
- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå
- ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
    - `@typespec/openapi3`ã ã‘ã¯OpenAPIå®šç¾©ã®ç´°ã‹ã„è¨­å®šã‚’ã—ãªã„ãªã‚‰ä¸è¦ã§ã™ã€‚
 
ä½œæˆãŒå®Œäº†ã™ã‚‹ã¨ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒä½œæˆã•ã‚Œã¾ã™ã€‚
```
package.json      
tspconfig.yaml # TypeSpecã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«
main.tsp       # ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ(å®šç¾©ãƒ•ã‚¡ã‚¤ãƒ«)
```


## APIå®šç¾©
ä»Šå›ã¯OpenAPIã®ã‚µãƒ³ãƒ—ãƒ«ã§ã‚ã‚‹PetStoreã®ã†ã¡ã€petã‚¿ã‚°ãŒä»˜ä¸ã•ã‚Œã¦ã„ã‚‹éƒ¨åˆ†ã‚’TypeSpecã§è¨˜è¿°ã—ã¦ã¿ã¾ã™ã€‚

```ts [main.tsp]
import "@typespec/http";
import "@typespec/rest";
import "@typespec/openapi3";

using TypeSpec.Rest;
using TypeSpec.Http;

@service({
  title: "Pet Store",
})
namespace PetStore;

model Pet {
  id: integer;
  name: string;
  category: {
    od: integer;
    name: string;
  };
  photoUrls: string[];
  tags: {
    id: integer;
    name: string;
  };
  status: "available" | "unavailable";
}

model Empty {}

@tag("pet")
@route("/pet")
interface Pets {
  @post
  registPet(@body body: Pet): Pet;
  @put
  updatePet(@body body: Pet): Pet;

  @route("/findByStatus")
  @get
  findByStatus(@query status: string): Pet;

  @route("/findByTags")
  @get
  findByTags(
    @query({
      format: "multi",
    })
    status: string[],
  ): Pet;
}

@tag("pet")
@route("/pet/{petId}")
namespace PetById {
  model Path {
    @path
    petId: string;
  }

  @get
  op findById(...Path): Pet;

  @post
  op updatePetById(...Path, @query name: string, @query status: string): Empty;

  @delete
  op deletePet(...Path): Empty;

  @route("/uploadImage")
  op uploadImage(...Path, @query addtionalMetadata: string): {
    code: integer;
    type: string;
    message: string;
  };
}
```
### [service](https://typespec.io/docs/standard-library/built-in-decorators#@service)
openapiã®infoã‚¿ã‚°ã®å†…å®¹ã‚’è¨˜è¿°ã§ãã¾ã™ã€‚
`typespec/openapi3`ã«ã‚‚`@info`ã¨ã„ã†ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ãŒå­˜åœ¨ã—ã¾ã™ãŒã€titleã¨versionä»¥å¤–ã®å®šç¾©ãŒå¿…è¦ãªå ´åˆã¯ãã¡ã‚‰ã‚’ä½¿ç”¨ã™ã‚‹ã®ãŒè‰¯ã„ã¨æ€ã„ã¾ã™ã€‚

```ts
@service({
  title: "Pet Store",
})

// serviceå®£è¨€æ™‚ã¯ãƒ•ã‚¡ã‚¤ãƒ«ãƒ¬ãƒ™ãƒ«ã®namespaceãŒå¿…è¦
namespace PetStore;
```

### [model](https://typespec.io/docs/language-basics/models)
ãƒ‡ãƒ¼ã‚¿ã‚¹ã‚­ãƒ¼ãƒã‚’å®šç¾©ã—ã¾ã™ã€‚openapiã§ã„ãˆã°componentsã¨åŒã˜ã§ã™ã€‚
TypeScripã®ã‚ˆã†ã«ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰æ§‹æ–‡ã‚„ã‚¸ã‚§ãƒãƒªã‚¯ã‚¹ã‚‚åˆ©ç”¨å¯èƒ½ãªãŸã‚ã€æ±ç”¨æ€§ã¯é«˜ã„ã¨æ€ã„ã¾ã™ã€‚
```ts
model Pet {
  id: integer;
  name: string;
  category: {
    od: integer;
    name: string;
  };
  photoUrls: string[];
  tags: {
    id: integer;
    name: string;
  };
  status: "available" | "unavailable";
}
```

### [operation](https://typespec.io/docs/language-basics/operations)
ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ç´ã¥ãæ“ä½œã‚’å®šç¾©ã—ã€ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã€ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã€è­˜åˆ¥å­ã¨ãªã‚‹åå‰ã‚’å®£è¨€ã—ã¾ã™ã€‚`@typespec/http`ã«ã‚ˆã‚Šåˆ©ç”¨å¯èƒ½ãªãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã§HTTPãƒ¡ã‚½ãƒƒãƒ‰ã‚„ãƒ‘ã‚¹ã‚’ã‚ã‹ã‚Šã‚„ã™ãå®šç¾©å¯èƒ½ã§ã™ã€‚

```ts
@post
registPet(@body body: Pet): Pet;

@put
updatePet(@body body: Pet): Pet;

@route("/findByStatus")
@get
findByStatus(@query status: string): Pet;
```

### [namespace](https://typespec.io/docs/language-basics/namespaces)
namespaceã¯æ§˜ã€…ãªå‹å®šç¾©ã‚’ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
model, operation, namespaceãªã©typespecã§å®šç¾©å¯èƒ½ãªå‹ã¯ã»ã¨ã‚“ã©å«ã‚ã‚‰ã‚Œã¾ã™ã€‚
```ts
@tag("pet")
@route("/pet/{petId}")
namespace PetById {
  model Path {
    @path
    petId: string;
  }

  @get
  op findById(...Path): Pet;

  @post
  op updatePetById(...Path, @query name: string, @query status: string): Empty;

  @delete
  op deletePet(...Path): Empty;

  @route("/uploadImage")
  op uploadImage(...Path, @query addtionalMetadata: string): {
    code: integer;
    type: string;
    message: string;
  };
}
```

### [interface](https://typespec.io/docs/language-basics/interfaces)
interfaceã¯operationã‚’ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã—ã¾ã™ã€‚
operationã®ã¿ãŒå®šç¾©å¯èƒ½ã§ã€namespaceã§ã®è¨˜è¿°ã§ã¯å¿…è¦ã ã£ãŸ`op`ãŒä¸è¦ã¨ãªã‚Šã¾ã™ã€‚
```ts
@tag("pet")
@route("/pet")
interface Pets {
  @post
  registPet(@body body: Pet): Pet;
  @put
  updatePet(@body body: Pet): Pet;

  @route("/findByStatus")
  @get
  findByStatus(@query status: string): Pet;

  @route("/pet/findByTags")
  @get
  findByTags(
    @query({
      format: "multi",
    })
    status: string[],
  ): Pet;
}
```

## å‡ºåŠ›
OpenAPIã®å‡ºåŠ›ã«ã¯ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚
```sh
tsp compile .

# ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’æŒ‡å®šã™ã‚‹å ´åˆ
tsp compile . --output-dir å‡ºåŠ›ã™ã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª

# ãƒ•ã‚¡ã‚¤ãƒ«åã‚’æŒ‡å®šã™ã‚‹å ´åˆ
tsp compile . --options @typespec/openapi3.output-file=ãƒ•ã‚¡ã‚¤ãƒ«å

# ãƒ•ã‚¡ã‚¤ãƒ«åã‚’æŒ‡å®šã™ã‚‹å ´åˆ
tsp compile . --options @typespec/openapi3.output-file=ãƒ•ã‚¡ã‚¤ãƒ«å 
```
ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯`tsp-output/@typespec/openapi3/openapi.yaml`ã§å‡ºåŠ›ã•ã‚Œã¾ã™ã€‚
å‡ºåŠ›å…ˆã¯`{output-dir}/{emitterå}/{ãƒ•ã‚¡ã‚¤ãƒ«å}`ã®å½¢å¼ã§æ±ºã¾ã‚Šã€emitteråã®ç®‡æ‰€ã¯å¤‰æ›´ä¸å¯ã§ã™ã€‚

:::details å‡ºåŠ›ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«
```yaml:openapi.yaml
openapi: 3.0.0
info:
  title: Pet Store
  version: 0.0.0
tags:
  - name: pet
paths:
  /pet:
    post:
      tags:
        - pet
      operationId: Pets_registPet
      parameters: []
      responses:
        '200':
          description: The request has succeeded.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Pet'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Pet'
    put:
      tags:
        - pet
      operationId: Pets_updatePet
      parameters: []
      responses:
        '200':
          description: The request has succeeded.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Pet'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Pet'
  /pet/findByStatus:
    get:
      tags:
        - pet
      operationId: Pets_findByStatus
      parameters:
        - name: status
          in: query
          required: true
          schema:
            type: string
      responses:
        '200':
          description: The request has succeeded.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Pet'
  /pet/findByTags:
    get:
      tags:
        - pet
      operationId: Pets_findByTags
      parameters:
        - name: status
          in: query
          required: true
          schema:
            type: array
            items:
              type: string
          style: form
          explode: true
      responses:
        '200':
          description: The request has succeeded.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Pet'
  /pet/{petId}:
    get:
      tags:
        - pet
      operationId: PetById_findById
      parameters:
        - $ref: '#/components/parameters/PetById.Path'
      responses:
        '200':
          description: The request has succeeded.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Pet'
    post:
      tags:
        - pet
      operationId: PetById_updatePetById
      parameters:
        - $ref: '#/components/parameters/PetById.Path'
        - name: name
          in: query
          required: true
          schema:
            type: string
        - name: status
          in: query
          required: true
          schema:
            type: string
      responses:
        '200':
          description: The request has succeeded.
    delete:
      tags:
        - pet
      operationId: PetById_deletePet
      parameters:
        - $ref: '#/components/parameters/PetById.Path'
      responses:
        '200':
          description: The request has succeeded.
  /pet/{petId}/uploadImage:
    get:
      tags:
        - pet
      operationId: PetById_uploadImage
      parameters:
        - $ref: '#/components/parameters/PetById.Path'
        - name: addtionalMetadata
          in: query
          required: true
          schema:
            type: string
      responses:
        '200':
          description: The request has succeeded.
          content:
            application/json:
              schema:
                type: object
                properties:
                  code:
                    type: integer
                  type:
                    type: string
                  message:
                    type: string
                required:
                  - code
                  - type
                  - message
components:
  parameters:
    PetById.Path:
      name: petId
      in: path
      required: true
      schema:
        type: string
  schemas:
    Pet:
      type: object
      required:
        - id
        - name
        - category
        - photoUrls
        - tags
        - status
      properties:
        id:
          type: integer
        name:
          type: string
        category:
          type: object
          properties:
            od:
              type: integer
            name:
              type: string
          required:
            - od
            - name
        photoUrls:
          type: array
          items:
            type: string
        tags:
          type: object
          properties:
            id:
              type: integer
            name:
              type: string
          required:
            - id
            - name
        status:
          type: string
          enum:
            - available
            - unavailable

```
:::

## ã¾ã¨ã‚
ä»Šå›ã¯APIå®šç¾©è¨€èªã®TypeSpecã®ç´¹ä»‹ã§ã—ãŸã€‚
å€‹äººçš„ã«å¯èª­æ€§ãŒã‹ãªã‚Šé«˜ãã€typescriptã®aws-cdkã¨ä¸€ç·’ã«ä½¿ç”¨ã™ã‚‹ã¨ã‚ˆã•ãã†ã ãªã¨æ„Ÿã˜ã¾ã—ãŸã€‚nodejsã®ä½¿ç”¨ã«èºŠèº‡ãŒãªã„ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãªã‚‰å°å…¥ã‚’æ¤œè¨ã—ã¦ã‚‚ã‚ˆã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

ä»Šå›ç´¹ä»‹ã§ããªã‹ã£ãŸæ©Ÿèƒ½ã‚‚ã€èª¿ã¹ã¦è¨˜äº‹ã«ã—ã¦ã„ã‘ãŸã‚‰ã¨æ€ã„ã¾ã™ã€‚
